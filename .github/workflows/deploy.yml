# ============================================================================
# ğŸš€ WORKFLOW: Build, Test, Analyze and Push to ECR
# ============================================================================
# Este archivo define un pipeline de CI/CD que se ejecuta automÃ¡ticamente
# cuando haces "git push" a la rama main.
#
# FLUJO COMPLETO:
# git push â†’ Tests â†’ SonarCloud â†’ Build Docker â†’ Push a ECR â†’ App Runner
# ============================================================================

# ----------------------------------------------------------------------------
# NOMBRE DEL WORKFLOW
# ----------------------------------------------------------------------------
name: Build, Test and Push to ECR

# ----------------------------------------------------------------------------
# DISPARADOR (TRIGGER) - Â¿CuÃ¡ndo se ejecuta este workflow?
# ----------------------------------------------------------------------------
on:
  push:                        # Se activa cuando alguien hace "git push"
    branches: [ "main" ]       # SOLO si el push es a la rama "main"
  pull_request:                # TambiÃ©n se ejecuta en Pull Requests
    branches: [ "main" ]       # Para validar cÃ³digo antes de merge

# ----------------------------------------------------------------------------
# VARIABLES DE ENTORNO GLOBALES
# ----------------------------------------------------------------------------
env:
  # RegiÃ³n de AWS donde estÃ¡ tu ECR (Ohio = us-east-2)
  AWS_REGION: us-east-2
  
  # Nombre de tu repositorio en Amazon ECR
  ECR_REPOSITORY: ca1-app
  
  # âš ï¸ IMPORTANTE: Estos son los identificadores de tu proyecto en SonarCloud
  # El TOKEN va en GitHub Secrets, NO aquÃ­ en el archivo
  SONAR_ORGANIZATION: raulp07              # Tu organization en SonarCloud
  SONAR_PROJECT_KEY: raulp07_CA1           # El project key (org_repo)

# ----------------------------------------------------------------------------
# JOBS - Los trabajos que se van a ejecutar
# ----------------------------------------------------------------------------
jobs:
  
  # ==========================================================================
  # JOB 1: TEST AND ANALYZE (Pruebas y AnÃ¡lisis de CÃ³digo)
  # ==========================================================================
  # Este job ejecuta las pruebas unitarias y el anÃ¡lisis de SonarCloud
  test-and-analyze:
    name: ğŸ§ª Test and ğŸ” SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
    # ========================================================================
    # PASO 1: CHECKOUT DEL CÃ“DIGO
    # ========================================================================
    # fetch-depth: 0 es REQUERIDO por SonarCloud para analizar el historial
    - name: Checkout del cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # SonarCloud necesita el historial completo de Git

    # ========================================================================
    # PASO 2: CONFIGURAR .NET SDK
    # ========================================================================
    # Instala la versiÃ³n de .NET necesaria para compilar y probar el proyecto
    - name: Configurar .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'  # VersiÃ³n de .NET de tu proyecto

    # ========================================================================
    # PASO 3: INSTALAR JAVA (Requerido por SonarCloud Scanner)
    # ========================================================================
    # El scanner de SonarCloud estÃ¡ escrito en Java
    - name: Configurar Java 17 (requerido por SonarCloud)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # ========================================================================
    # PASO 4: INSTALAR SONARCLOUD SCANNER
    # ========================================================================
    # Instala la herramienta que analiza el cÃ³digo
    - name: Instalar SonarCloud Scanner
      run: |
        dotnet tool install --global dotnet-sonarscanner

    # ========================================================================
    # PASO 5: RESTAURAR DEPENDENCIAS
    # ========================================================================
    # Descarga todos los paquetes NuGet necesarios
    - name: Restaurar dependencias
      run: dotnet restore

    # ========================================================================
    # PASO 6: INICIAR ANÃLISIS DE SONARCLOUD
    # ========================================================================
    # Inicia el proceso de anÃ¡lisis ANTES de compilar
    # SonarCloud intercepta la compilaciÃ³n para analizar el cÃ³digo
    - name: Iniciar anÃ¡lisis de SonarCloud
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet sonarscanner begin \
          /k:"${{ env.SONAR_PROJECT_KEY }}" \
          /o:"${{ env.SONAR_ORGANIZATION }}" \
          /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
          /d:sonar.host.url="https://sonarcloud.io" \
          /d:sonar.cs.opencover.reportsPaths="**/TestResults/**/coverage.opencover.xml"

    # ========================================================================
    # PASO 7: COMPILAR EL PROYECTO
    # ========================================================================
    # Compila sin restaurar (ya lo hicimos antes)
    - name: Compilar proyecto
      run: dotnet build --no-restore

    # ========================================================================
    # PASO 8: EJECUTAR PRUEBAS UNITARIAS
    # ========================================================================
    # Ejecuta todas las pruebas y genera reporte de cobertura
    # El reporte de cobertura se envÃ­a a SonarCloud
    - name: Ejecutar pruebas unitarias
      run: |
        dotnet test --no-build --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

    # ========================================================================
    # PASO 9: FINALIZAR ANÃLISIS DE SONARCLOUD
    # ========================================================================
    # EnvÃ­a los resultados del anÃ¡lisis a SonarCloud
    - name: Finalizar anÃ¡lisis de SonarCloud
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

  # ==========================================================================
  # JOB 2: BUILD AND PUSH (Construir y Subir a ECR)
  # ==========================================================================
  # Este job solo se ejecuta si el job anterior (test-and-analyze) pasÃ³
  # Y solo en la rama main (no en Pull Requests)
  build-and-push:
    name: ğŸ³ Build and Push to ECR
    runs-on: ubuntu-latest
    
    # âš ï¸ DEPENDENCIA: Este job espera a que test-and-analyze termine con Ã©xito
    needs: test-and-analyze
    
    # âš ï¸ CONDICIÃ“N: Solo ejecutar en push a main (no en PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    # ========================================================================
    # PASO 1: CHECKOUT DEL CÃ“DIGO
    # ========================================================================
    - name: Checkout del cÃ³digo
      uses: actions/checkout@v4

    # ========================================================================
    # PASO 2: CONFIGURAR CREDENCIALES DE AWS
    # ========================================================================
    - name: Configurar credenciales de AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # ========================================================================
    # PASO 3: LOGIN EN AMAZON ECR
    # ========================================================================
    - name: Login en Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # ========================================================================
    # PASO 4: BUILD, TAG Y PUSH DE LA IMAGEN
    # ========================================================================
    - name: Build, tag, y push de la imagen a Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Construir la imagen Docker
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        
        # Subir ambas versiones a ECR
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "âœ… Imagen subida: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "âœ… Imagen subida: $ECR_REGISTRY/$ECR_REPOSITORY:latest"

# ============================================================================
# ğŸ“Š RESUMEN DEL PIPELINE
# ============================================================================
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                         git push main                           â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                    â”‚
#                                    â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  JOB 1: test-and-analyze                                        â”‚
#   â”‚  â”œâ”€â”€ Checkout cÃ³digo                                            â”‚
#   â”‚  â”œâ”€â”€ Setup .NET + Java                                          â”‚
#   â”‚  â”œâ”€â”€ Restaurar dependencias                                     â”‚
#   â”‚  â”œâ”€â”€ Iniciar SonarCloud                                         â”‚
#   â”‚  â”œâ”€â”€ Compilar                                                   â”‚
#   â”‚  â”œâ”€â”€ Ejecutar pruebas                                           â”‚
#   â”‚  â””â”€â”€ Finalizar SonarCloud â†’ EnvÃ­a resultados a sonarcloud.io   â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                    â”‚
#                         (Solo si pasan las pruebas)
#                                    â”‚
#                                    â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚  JOB 2: build-and-push                                          â”‚
#   â”‚  â”œâ”€â”€ Checkout cÃ³digo                                            â”‚
#   â”‚  â”œâ”€â”€ Configurar AWS                                             â”‚
#   â”‚  â”œâ”€â”€ Login ECR                                                  â”‚
#   â”‚  â””â”€â”€ Build + Push imagen Docker                                 â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                    â”‚
#                                    â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                    ECR: ca1-app:latest                          â”‚
#   â”‚                         â†“                                       â”‚
#   â”‚                    App Runner detecta                           â”‚
#   â”‚                         â†“                                       â”‚
#   â”‚                    ğŸŒ URL PÃºblica                               â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ============================================================================
# ğŸ” SECRETS NECESARIOS EN GITHUB
# ============================================================================
#
# Ve a: Settings â†’ Secrets â†’ Actions â†’ New repository secret
#
# | Nombre                  | DescripciÃ³n                              |
# |-------------------------|------------------------------------------|
# | AWS_ACCESS_KEY_ID       | Tu Access Key de AWS IAM                 |
# | AWS_SECRET_ACCESS_KEY   | Tu Secret Key de AWS IAM                 |
# | SONAR_TOKEN             | Token de SonarCloud (My Account â†’ Security) |
#
# ============================================================================
# ğŸ”— RECURSOS ÃšTILES
# ============================================================================
# 
# DocumentaciÃ³n GitHub Actions: https://docs.github.com/en/actions
# DocumentaciÃ³n SonarCloud: https://docs.sonarcloud.io/
# DocumentaciÃ³n AWS ECR: https://docs.aws.amazon.com/ecr/
#
# ============================================================================
